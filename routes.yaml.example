# Bullet 路由配置示例
#
# 路由规则按顺序匹配，第一个匹配的规则会被使用
# 匹配条件支持:
#   - source: 事件来源 (grafana, alertmanager, 等)
#   - labels: 事件标签 (所有指定标签必须匹配)
# 如果没有匹配的规则，事件会被丢弃

routes:
  # 示例 1: 只匹配 Grafana 来源的后端项目事件（报警只是其中一种场景）
  - name: "grafana-backend"
    match:
      source: grafana
      labels:
        project: "backend-api"
    channels:
      - type: feishu
        webhook_url: "https://open.feishu.cn/open-apis/bot/v2/hook/xxx-backend"

  # 示例 2: 匹配特定来源和多个标签
  - name: "grafana-frontend-prod"
    match:
      source: grafana
      labels:
        project: "frontend"
        env: "production"
    channels:
      - type: feishu
        webhook_url: "https://open.feishu.cn/open-apis/bot/v2/hook/xxx-frontend"

  # 示例 3: 只根据标签匹配，不限来源
  - name: "infra-alerts"
    match:
      labels:
        team: "infrastructure"
    channels:
      - type: feishu
        webhook_url: "https://open.feishu.cn/open-apis/bot/v2/hook/xxx-infra"

  # 示例 4: 只根据来源匹配，不限标签
  - name: "all-alertmanager"
    match:
      source: alertmanager
    channels:
      - type: feishu
        webhook_url: "https://open.feishu.cn/open-apis/bot/v2/hook/xxx-alertmanager"

  # 示例 5: 发送到多个渠道
  - name: "critical-alerts"
    match:
      labels:
        severity: "critical"
    channels:
      - type: feishu
        webhook_url: "https://open.feishu.cn/open-apis/bot/v2/hook/xxx-oncall"
      - type: feishu
        webhook_url: "https://open.feishu.cn/open-apis/bot/v2/hook/xxx-managers"

  # 示例 6: 兜底路由 (匹配所有，放最后)
  - name: "catch-all"
    match: {}
    channels:
      - type: feishu
        webhook_url: "https://open.feishu.cn/open-apis/bot/v2/hook/xxx-default"

  # 示例 7: 发送邮件（Resend）
  - name: "critical-email"
    match:
      labels:
        severity: "critical"
    channels:
      - type: resend_email
        # 建议把 API Key 放在环境变量 RESEND_API_KEY
        # api_key: "re_xxxxxxxxx"
        from: "Bullet <noreply@your-domain.com>"
        to:
          - "oncall@your-domain.com"
          - "devops@your-domain.com"
        subject_prefix: "[SRE] "
        # 可选：自定义模板（Jinja2），不填则用内置默认模板
        # template_path: "/abs/path/to/resend_email.html.j2"
        # 可选：自定义 subject 模板（Jinja2 from_string）
        # subject_template: "[{{ event.source|upper }}] {{ event.type }}"
